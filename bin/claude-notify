#!/bin/bash
#
# claude-notify - macOS용 Claude Code 알림 플러그인
#
# 사용법:
#   claude-notify "메시지"
#   claude-notify "메시지" --title "타이틀"
#   claude-notify "메시지" --sound Glass
#   claude-notify "메시지" --silent
#   claude-notify "메시지" --activate  # 클릭 시 터미널로 이동
#

set -e

# 기본값
TITLE="Claude Code"
SUBTITLE=""
SOUND="Glass"
SILENT=false
ACTIVATE=true
MESSAGE=""

# 터미널/IDE 앱 자동 감지 (현재 포커스된 앱 기준)
detect_terminal() {
    # 현재 포커스된 앱 확인
    local frontmost
    frontmost=$(osascript -e 'tell application "System Events" to get bundle identifier of first process whose frontmost is true' 2>/dev/null || echo "")

    # IDE/터미널 앱이면 그대로 반환
    case "$frontmost" in
        # JetBrains IDEs
        com.jetbrains.intellij*)    echo "$frontmost"; return ;;
        com.jetbrains.WebStorm*)    echo "$frontmost"; return ;;
        com.jetbrains.pycharm*)     echo "$frontmost"; return ;;
        com.jetbrains.goland*)      echo "$frontmost"; return ;;
        com.jetbrains.rider*)       echo "$frontmost"; return ;;
        com.jetbrains.rubymine*)    echo "$frontmost"; return ;;
        com.jetbrains.phpstorm*)    echo "$frontmost"; return ;;
        com.jetbrains.clion*)       echo "$frontmost"; return ;;
        com.jetbrains.datagrip*)    echo "$frontmost"; return ;;
        com.jetbrains.fleet*)       echo "$frontmost"; return ;;
        # VSCode
        com.microsoft.VSCode*)      echo "$frontmost"; return ;;
        com.visualstudio.code*)     echo "$frontmost"; return ;;
        # Cursor
        com.todesktop.*)            echo "$frontmost"; return ;;
        # Zed
        dev.zed.Zed*)               echo "$frontmost"; return ;;
        # 터미널 앱들
        com.googlecode.iterm2)      echo "$frontmost"; return ;;
        com.mitchellh.ghostty)      echo "$frontmost"; return ;;
        org.alacritty)              echo "$frontmost"; return ;;
        net.kovidgoyal.kitty)       echo "$frontmost"; return ;;
        com.github.wez.wezterm)     echo "$frontmost"; return ;;
        com.apple.Terminal)         echo "$frontmost"; return ;;
    esac

    # 포커스된 앱이 IDE/터미널이 아니면 실행 중인 터미널 찾기
    if pgrep -x "iTerm2" > /dev/null; then
        echo "com.googlecode.iterm2"
    elif pgrep -x "Ghostty" > /dev/null; then
        echo "com.mitchellh.ghostty"
    elif pgrep -x "Code" > /dev/null; then
        echo "com.microsoft.VSCode"
    elif pgrep -x "idea" > /dev/null; then
        echo "com.jetbrains.intellij"
    elif pgrep -x "webstorm" > /dev/null; then
        echo "com.jetbrains.WebStorm"
    else
        echo "com.apple.Terminal"
    fi
}

# 인자 파싱
while [[ $# -gt 0 ]]; do
    case $1 in
        --title|-t)
            TITLE="$2"
            shift 2
            ;;
        --subtitle)
            SUBTITLE="$2"
            shift 2
            ;;
        --sound|-s)
            SOUND="$2"
            shift 2
            ;;
        --silent|-q)
            SILENT=true
            shift
            ;;
        --activate|-a)
            ACTIVATE=true
            shift
            ;;
        --no-activate)
            ACTIVATE=false
            shift
            ;;
        --help|-h)
            echo "사용법: claude-notify \"메시지\" [옵션]"
            echo ""
            echo "옵션:"
            echo "  --title, -t      알림 타이틀 (기본: Claude Code)"
            echo "  --sound, -s      알림 사운드 (기본: Glass)"
            echo "  --silent, -q     사운드 없이 알림"
            echo "  --activate, -a   클릭 시 터미널 활성화 (기본: true)"
            echo "  --no-activate    클릭 시 아무 동작 없음"
            echo "  --help, -h       도움말"
            echo ""
            echo "사용 가능한 사운드:"
            echo "  Glass, Ping, Pop, Purr, Submarine, Blow, Bottle,"
            echo "  Frog, Funk, Hero, Morse, Tink"
            exit 0
            ;;
        -*)
            echo "알 수 없는 옵션: $1" >&2
            exit 1
            ;;
        *)
            MESSAGE="$1"
            shift
            ;;
    esac
done

# 메시지 필수
if [[ -z "$MESSAGE" ]]; then
    echo "오류: 메시지를 입력하세요" >&2
    echo "사용법: claude-notify \"메시지\"" >&2
    exit 1
fi

# macOS 확인
if [[ "$(uname)" != "Darwin" ]]; then
    echo "오류: macOS에서만 동작합니다" >&2
    exit 1
fi

# terminal-notifier 사용 (클릭 시 터미널로 이동)
if command -v terminal-notifier &> /dev/null; then
    TERMINAL_APP=$(detect_terminal)

    args=(-title "$TITLE" -message "$MESSAGE" -group "claude-code")

    if [[ -n "$SUBTITLE" ]]; then
        args+=(-subtitle "$SUBTITLE")
    fi

    if [[ "$ACTIVATE" == "true" ]]; then
        args+=(-activate "$TERMINAL_APP")
    fi

    if [[ "$SILENT" != "true" ]]; then
        args+=(-sound "$SOUND")
    fi

    terminal-notifier "${args[@]}" 2>/dev/null || true
else
    # fallback to osascript
    if [[ "$SILENT" == "true" ]]; then
        osascript -e "display notification \"$MESSAGE\" with title \"$TITLE\""
    else
        osascript -e "display notification \"$MESSAGE\" with title \"$TITLE\" sound name \"$SOUND\""
    fi
fi
