#!/bin/bash
#
# claude-notify-hook - Stop hook용 고도화된 알림
#
# Hook input (stdin):
# {
#   "session_id": "...",
#   "transcript_path": "...",
#   "cwd": "...",
#   "hook_event_name": "Stop"
# }
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# stdin에서 JSON 읽기
input=$(cat)

# JSON 파싱 (jq 필요)
if ! command -v jq &> /dev/null; then
    "$SCRIPT_DIR/claude-notify" "응답 완료"
    exit 0
fi

transcript=$(echo "$input" | jq -r '.transcript_path // empty')
cwd=$(echo "$input" | jq -r '.cwd // empty')

# 프로젝트 이름 추출 (폴더명)
if [[ -n "$cwd" ]]; then
    project_name=$(basename "$cwd")
else
    project_name="Claude"
fi

# 기본값
message="응답 완료"
title="$project_name"
sound="Glass"

if [[ -n "$transcript" && -f "$transcript" ]]; then
    # 마지막 도구 이름 추출
    last_tool=$(tail -50 "$transcript" 2>/dev/null \
        | jq -r 'select(.tool_name) | .tool_name' 2>/dev/null \
        | tail -1)

    # 에러 확인
    has_error=$(tail -20 "$transcript" 2>/dev/null \
        | jq -r 'select(.type == "tool_result" and .success == false) | "error"' 2>/dev/null \
        | head -1)

    # 도구 개수
    tool_count=$(grep -c '"tool_name"' "$transcript" 2>/dev/null || echo "0")

    # 메시지 구성
    if [[ -n "$has_error" ]]; then
        message="에러 발생!"
        sound="Basso"
    elif [[ -n "$last_tool" ]]; then
        case "$last_tool" in
            "Task")
                message="Agent 완료"
                sound="Hero"
                ;;
            "Bash")
                message="명령 완료"
                ;;
            "Write"|"Edit")
                message="파일 수정"
                ;;
            "Read"|"Glob"|"Grep")
                message="탐색 완료"
                sound="Pop"
                ;;
            *)
                message="$last_tool 완료"
                ;;
        esac
    fi

    # 도구 사용 횟수
    if [[ "$tool_count" -gt 5 ]]; then
        message="$message (${tool_count}개)"
    fi
fi

# 알림 발송
"$SCRIPT_DIR/claude-notify" "$message" --title "$title" --sound "$sound"

exit 0
