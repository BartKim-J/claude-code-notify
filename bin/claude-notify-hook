#!/bin/bash
#
# claude-notify-hook - Stop hook용 고도화된 알림
#
# Hook input (stdin):
# {
#   "session_id": "...",
#   "transcript_path": "...",
#   "cwd": "...",
#   "hook_event_name": "Stop"
# }
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# 의존성 자동 설치 (최초 1회)
check_dependencies() {
    local need_install=false

    if ! command -v terminal-notifier &> /dev/null; then
        need_install=true
    fi
    if ! command -v jq &> /dev/null; then
        need_install=true
    fi

    if [[ "$need_install" == "true" ]]; then
        if command -v brew &> /dev/null; then
            brew install terminal-notifier jq 2>/dev/null &
        fi
    fi
}

# 백그라운드로 의존성 체크 (알림 지연 방지)
check_dependencies &

# stdin에서 JSON 읽기
input=$(cat)

# jq 없으면 기본 알림
if ! command -v jq &> /dev/null; then
    "$SCRIPT_DIR/claude-notify" "응답 완료"
    exit 0
fi

transcript=$(echo "$input" | jq -r '.transcript_path // empty')
cwd=$(echo "$input" | jq -r '.cwd // empty')

# 프로젝트 이름 추출 (폴더명)
if [[ -n "$cwd" ]]; then
    project_name=$(basename "$cwd")
else
    project_name="Claude"
fi

# 기본값
message="응답 완료"
subtitle=""
title="$project_name"
sound="Glass"

if [[ -n "$transcript" && -f "$transcript" ]]; then
    # 마지막 assistant 응답 추출 (200자)
    last_response=$(tail -100 "$transcript" 2>/dev/null \
        | jq -r 'select(.message.role == "assistant") | .message.content[] | select(.type == "text") | .text' 2>/dev/null \
        | grep -v "^No response" \
        | tail -1 \
        | tr '\n' ' ' \
        | sed 's/  */ /g' \
        | head -c 200)

    # 마지막 도구 이름 추출
    last_tool=$(tail -50 "$transcript" 2>/dev/null \
        | jq -r 'select(.tool_name) | .tool_name' 2>/dev/null \
        | tail -1)

    # 도구 개수
    tool_count=$(grep -c '"tool_name"' "$transcript" 2>/dev/null || echo "0")

    # 에러 확인
    has_error=$(tail -20 "$transcript" 2>/dev/null \
        | jq -r 'select(.type == "tool_result" and .success == false) | "error"' 2>/dev/null \
        | head -1)

    # 메시지 구성
    if [[ -n "$has_error" ]]; then
        message="에러 발생!"
        sound="Basso"
    elif [[ -n "$last_response" && ${#last_response} -gt 5 ]]; then
        # 첫 줄: 응답 앞부분 (80자)
        message=$(echo "$last_response" | head -c 80)
        if [[ ${#last_response} -gt 80 ]]; then
            message="${message}..."
        fi
        # 두번째 줄: 응답 뒷부분 (80자)
        if [[ ${#last_response} -gt 80 ]]; then
            subtitle=$(echo "$last_response" | tail -c +81 | head -c 80)
            if [[ ${#last_response} -gt 160 ]]; then
                subtitle="${subtitle}..."
            fi
        fi
    elif [[ -n "$last_tool" ]]; then
        case "$last_tool" in
            "Task")
                message="Agent 완료"
                sound="Hero"
                ;;
            "Bash")
                message="명령 완료"
                ;;
            "Write"|"Edit")
                message="파일 수정"
                ;;
            "Read"|"Glob"|"Grep")
                message="탐색 완료"
                sound="Pop"
                ;;
            *)
                message="$last_tool 완료"
                ;;
        esac
    fi

    # 도구 사용 횟수가 많으면 subtitle에 추가
    if [[ -z "$subtitle" && "$tool_count" -gt 3 ]]; then
        subtitle="${tool_count}개 도구 사용"
    fi
fi

# 알림 발송
if [[ -n "$subtitle" ]]; then
    "$SCRIPT_DIR/claude-notify" "$message" --title "$title" --subtitle "$subtitle" --sound "$sound"
else
    "$SCRIPT_DIR/claude-notify" "$message" --title "$title" --sound "$sound"
fi

exit 0
